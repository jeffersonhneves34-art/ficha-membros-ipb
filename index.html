// Configura√ß√£o
const ADMIN_PASSWORD = 'admin2026'; // Altere esta senha
// Cole aqui a URL do seu App da Web do Google Apps Script
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbycbrHL1NIrljTUki41cc9HVDjY40G38E4tiRzeeoDqFW5F2Fk2a4YGP4HTla2gHcxR/exec';
let isAdminLoggedIn = false;
let membersDatabase = [];

// Inicializa√ß√£o
window.addEventListener('DOMContentLoaded', () => {
    // Os dados agora s√£o carregados sob demanda no painel de admin
    updateMemberCount();
});

// Alternar entre modos
function showMode(mode) {
    const modes = document.querySelectorAll('.mode-content');
    modes.forEach(m => m.classList.remove('active'));
    
    if (mode === 'member') {
        document.getElementById('memberMode').classList.add('active');
    } else {
        document.getElementById('adminMode').classList.add('active');
        if (isAdminLoggedIn) {
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadAndDisplayMembers(); // Carrega os dados da planilha ao entrar no painel
        }
    }
}

// Login Admin
function checkAdminPassword() {
    const password = document.getElementById('adminPassword').value;
    
    if (password === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadAndDisplayMembers();
        showNotification('‚úÖ Login realizado com sucesso!', 'success');
    } else {
        showNotification('‚ùå Senha incorreta!', 'error');
        document.getElementById('adminPassword').value = '';
    }
}

// Logout Admin
function logout() {
    isAdminLoggedIn = false;
    document.getElementById('adminLogin').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('adminPassword').value = '';
    showNotification('üö™ Logout realizado', 'success');
}

// Envio do formul√°rio
document.getElementById('memberForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    showLoading(true);

    // Valida√ß√£o do consentimento
    const consentimentoChecked = document.getElementById('consentimento').checked;
    if (!consentimentoChecked) {
        showLoading(false);
        showNotification('‚ùå √â necess√°rio concordar com o uso dos dados para continuar.', 'error');
        return;
    }
    
    const formData = new FormData(e.target);
    const memberData = {
        id: Date.now(),
        dataCadastro: new Date().toISOString(),
        nome: formData.get('nome'),
        endereco: formData.get('endereco'),
        cidade: formData.get('cidade'),
        pais: formData.get('pais'),
        cep: formData.get('cep'),
        celular: formData.get('celular'),
        telefone: formData.get('telefone'),
        email: formData.get('email'),
        dataNascimento: formData.get('dataNascimento'),
        naturalidade: formData.get('naturalidade'),
        sexo: formData.get('sexo'),
        estadoCivil: formData.get('estadoCivil'),
        nomeConjuge: formData.get('nomeConjuge'),
        dataCasamento: formData.get('dataCasamento'),
        rg: formData.get('rg'),
        escolaridade: formData.get('escolaridade'),
        profissao: formData.get('profissao'),
        nomePai: formData.get('nomePai'),
        nomeMae: formData.get('nomeMae'),
        tipoMembro: formData.get('tipoMembro'),
        cargo: formData.get('cargo'),
        dataBatismo: formData.get('dataBatismo'),
        pastorBatismo: formData.get('pastorBatismo'),
        igrejaBatismo: formData.get('igrejaBatismo'),
        dataProfissao: formData.get('dataProfissao'),
        pastorProfissao: formData.get('pastorProfissao'),
        igrejaProfissao: formData.get('igrejaProfissao'),
        consentimento: consentimentoChecked,
    };
    
    try {
        // Salvar no armazenamento compartilhado
        await sendToGoogleSheet(memberData);
        
        showLoading(false);
        showNotification('‚úÖ Cadastro enviado com sucesso! Obrigado por preencher seus dados.', 'success');
        
        // Limpar formul√°rio
        e.target.reset();
        
        // Scroll para o topo
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
    } catch (error) {
        showLoading(false);
        showNotification('‚ùå Erro ao enviar cadastro. Tente novamente.', 'error');
        console.error('Erro:', error);
    }
});

// Enviar dados para a Planilha Google
async function sendToGoogleSheet(data) {
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Importante para evitar erros de CORS
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
            redirect: 'follow'
        });

        // Adiciona √† lista local para atualizar o painel de admin sem recarregar
        membersDatabase.push(data);
        updateMemberCount();
    } catch (error) {
        console.error('Erro ao enviar para o Google Sheet:', error);
        throw error;
    }
}

// Carrega e exibe os membros da Planilha Google
async function loadAndDisplayMembers() {
    showLoading(true);
    try {
        // Adiciona um par√¢metro 'action=read' para o script do Google saber o que fazer
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=read`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        // Verifica se a resposta do script foi bem-sucedida
        if (data.status === 'success') {
            membersDatabase = data.data;
            updateMemberCount();
            displayMembers();
        } else {
            throw new Error(data.message || 'Falha ao carregar dados da planilha.');
        }
    } catch (error) {
        console.error('Erro ao carregar membros:', error);
        showNotification('‚ùå Erro ao carregar membros da planilha.', 'error');
        // Exibe o painel de admin com uma mensagem de erro
        const membersList = document.getElementById('membersList');
        membersList.innerHTML = `
            <div class="empty-state">
                <h3>‚ö†Ô∏è Falha na Conex√£o</h3>
                <p>N√£o foi poss√≠vel carregar os dados da planilha. Verifique a URL do script e sua conex√£o.</p>
            </div>
        `;
    } finally {
        showLoading(false);
    }
}

// Exibir membros (apenas para admin)
function displayMembers() {
    const membersList = document.getElementById('membersList');
    
    if (membersDatabase.length === 0) {
        membersList.innerHTML = `
            <div class="empty-state">
                <h3>üìã Nenhum membro cadastrado ainda</h3>
                <p>Os cadastros enviados pelos membros aparecer√£o aqui.</p>
            </div>
        `;
        return;
    }
    
    // Ordenar por data de cadastro (mais recentes primeiro)
    const sortedMembers = [...membersDatabase].sort((a, b) => 
        new Date(b.dataCadastro) - new Date(a.dataCadastro)
    );
    
    membersList.innerHTML = sortedMembers.map(member => `
        <div class="member-card" data-id="${member.id}">
            <div class="member-header">
                <div class="member-name">${member.nome}</div>
                <button class="btn-delete" onclick="deleteMember(${member.id})">üóëÔ∏è Excluir</button>
            </div>
            <div class="member-details">
                <div class="member-detail">
                    <strong>üìß Email:</strong> ${member.email}
                </div>
                <div class="member-detail">
                    <strong>üì± Celular:</strong> ${member.celular}
                </div>
                <div class="member-detail">
                    <strong>‚òéÔ∏è Telefone:</strong> ${member.telefone || 'N√£o informado'}
                </div>
                <div class="member-detail">
                    <strong>üéÇ Nascimento:</strong> ${formatDate(member.dataNascimento)}
                </div>
                <div class="member-detail">
                    <strong>üìç Cidade:</strong> ${member.cidade}
                </div>
                <div class="member-detail">
                    <strong>üë§ Sexo:</strong> ${member.sexo}
                </div>
                <div class="member-detail">
                    <strong>üíº Profiss√£o:</strong> ${member.profissao || 'N√£o informado'}
                </div>
                <div class="member-detail">
                    <strong>‚õ™ Tipo:</strong> ${member.tipoMembro}
                </div>
                <div class="member-detail">
                    <strong>üéñÔ∏è Cargo:</strong> ${member.cargo || 'N√£o informado'}
                </div>
                <div class="member-detail">
                    <strong>üìÖ Cadastrado em:</strong> ${new Date(member.dataCadastro).toLocaleString('pt-BR')}
                </div>
            </div>
        </div>
    `).join('');
}

// Filtrar membros
function filterMembers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const memberCards = document.querySelectorAll('.member-card');
    
    memberCards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
}

// Excluir membro
async function deleteMember(id) {
    if (!confirm('‚ùå Tem certeza que deseja excluir este membro?')) {
        return;
    }
    
    showLoading(true);
    
    try {
        // Envia uma requisi√ß√£o para o script do Google para deletar o membro
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', id: id })
        });

        // Remove o membro da lista local para atualizar a interface
        const index = membersDatabase.findIndex(member => member.id == id); // Usar '==' pode ser mais seguro aqui
        if (index > -1) {
            membersDatabase.splice(index, 1);
        }

        // Atualiza a exibi√ß√£o
        displayMembers();
        updateMemberCount();
        showNotification('üóëÔ∏è Membro exclu√≠do!', 'success');
    } catch (error) {
        console.error('Erro ao excluir membro:', error);
        showNotification('‚ùå Erro ao excluir membro', 'error');
    } finally {
        showLoading(false);
    }
}

// Exportar para Excel
function exportToExcel() {
    if (membersDatabase.length === 0) {
        alert('‚ö†Ô∏è N√£o h√° membros cadastrados para exportar!');
        return;
    }
    
    // Preparar dados
    const exportData = membersDatabase.map(member => ({
        'Nome': member.nome,
        'Email': member.email,
        'Celular': member.celular,
        'Telefone': member.telefone || '',
        'Data Nascimento': formatDate(member.dataNascimento),
        'Naturalidade': member.naturalidade || '',
        'Sexo': member.sexo,
        'Endere√ßo': member.endereco,
        'Cidade/UF': member.cidade,
        'Pa√≠s': member.pais,
        'CEP': member.cep || '',
        'Estado Civil': member.estadoCivil || '',
        'Nome C√¥njuge': member.nomeConjuge || '',
        'Data Casamento': member.dataCasamento ? formatDate(member.dataCasamento) : '',
        'RG': member.rg || '',
        'Escolaridade': member.escolaridade || '',
        'Profiss√£o': member.profissao || '',
        'Nome Pai': member.nomePai || '',
        'Nome M√£e': member.nomeMae || '',
        'Tipo Membro': member.tipoMembro,
        'Cargo': member.cargo || '',
        'Data Batismo': member.dataBatismo ? formatDate(member.dataBatismo) : '',
        'Pastor Batismo': member.pastorBatismo || '',
        'Igreja Batismo': member.igrejaBatismo || '',
        'Data Profiss√£o F√©': member.dataProfissao ? formatDate(member.dataProfissao) : '',
        'Pastor Profiss√£o F√©': member.pastorProfissao || '',
        'Igreja Profiss√£o F√©': member.igrejaProfissao || '',
        'Data Cadastro': new Date(member.dataCadastro).toLocaleString('pt-BR')
    }));
    
    // Criar planilha
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Membros ipb");
    
    // Largura das colunas
    ws['!cols'] = Array(28).fill({ wch: 20 });
    
    // Baixar arquivo
    const fileName = `membros_ipb_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    showNotification('üì• Planilha exportada com sucesso!', 'success');
}

// Atualizar contador
function updateMemberCount() {
    const counter = document.getElementById('totalMembros');
    if (counter) {
        counter.textContent = membersDatabase.length;
    }
}

// Formatar data
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'T00:00:00');
    return date.toLocaleDateString('pt-BR');
}

// Mostrar notifica√ß√£o
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

// Loading
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

// M√°scaras para inputs
function applyMask(e, maskFunction) {
    let value = e.target.value.replace(/\D/g, '');
    e.target.value = maskFunction(value);
}

const maskCelular = (value) => {
    return value.slice(0, 11)
        .replace(/(\d{2})(\d)/, '($1) $2')
        .replace(/(\d{5})(\d)/, '$1-$2');
};

const maskTelefone = (value) => {
    return value.slice(0, 10)
        .replace(/(\d{2})(\d)/, '($1) $2')
        .replace(/(\d{4})(\d)/, '$1-$2');
};

const maskCep = (value) => value.slice(0, 8).replace(/(\d{5})(\d)/, '$1-$2');

document.getElementById('celular').addEventListener('input', (e) => applyMask(e, maskCelular));
document.getElementById('telefone').addEventListener('input', (e) => applyMask(e, maskTelefone));
document.getElementById('cep').addEventListener('input', (e) => applyMask(e, maskCep));
